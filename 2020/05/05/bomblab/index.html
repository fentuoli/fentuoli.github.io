<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"fentuoli.github.io","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":"default"},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":true,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="BOMBLAB说明：CSAPP实验是很有名的实验，我为了完成课堂任务总共写了四个实验：bomblab、cachelab、datalab和malloclab，在做的过程中也参考了许多人的博客，其中主要参考了*码龙的窝： https:&#x2F;&#x2F;blog.codedragon.tech&#x2F;about&#x2F; *，在此感谢！ 一、实验内容及要求Bomb Lab主要是关于反汇编的实验，对应于书本的第三章：程序的机器级表示">
<meta property="og:type" content="article">
<meta property="og:title" content="bomblab">
<meta property="og:url" content="http://fentuoli.github.io/2020/05/05/bomblab/index.html">
<meta property="og:site_name" content="BoRe">
<meta property="og:description" content="BOMBLAB说明：CSAPP实验是很有名的实验，我为了完成课堂任务总共写了四个实验：bomblab、cachelab、datalab和malloclab，在做的过程中也参考了许多人的博客，其中主要参考了*码龙的窝： https:&#x2F;&#x2F;blog.codedragon.tech&#x2F;about&#x2F; *，在此感谢！ 一、实验内容及要求Bomb Lab主要是关于反汇编的实验，对应于书本的第三章：程序的机器级表示">
<meta property="og:image" content="http://fentuoli.github.io/2020/05/05/bomblab/1.PNG">
<meta property="og:image" content="http://fentuoli.github.io/2020/05/05/bomblab/2.PNG">
<meta property="og:image" content="http://fentuoli.github.io/2020/05/05/bomblab/3.PNG">
<meta property="og:image" content="http://fentuoli.github.io/2020/05/05/bomblab/17.PNG">
<meta property="og:image" content="http://fentuoli.github.io/2020/05/05/bomblab/4.PNG">
<meta property="og:image" content="http://fentuoli.github.io/2020/05/05/bomblab/5.PNG">
<meta property="og:image" content="http://fentuoli.github.io/2020/05/05/bomblab/18.PNG">
<meta property="og:image" content="http://fentuoli.github.io/2020/05/05/bomblab/5.PNG">
<meta property="og:image" content="http://fentuoli.github.io/2020/05/05/bomblab/19.png">
<meta property="og:image" content="http://fentuoli.github.io/2020/05/05/bomblab/20.png">
<meta property="og:image" content="http://fentuoli.github.io/2020/05/05/bomblab/21.png">
<meta property="og:image" content="http://fentuoli.github.io/2020/05/05/bomblab/22.png">
<meta property="og:image" content="http://fentuoli.github.io/2020/05/05/bomblab/23.png">
<meta property="og:image" content="http://fentuoli.github.io/2020/05/05/bomblab/7.PNG">
<meta property="article:published_time" content="2020-05-05T06:43:14.000Z">
<meta property="article:modified_time" content="2020-05-05T06:56:22.285Z">
<meta property="article:author" content="般若">
<meta property="article:tag" content="csapp">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://fentuoli.github.io/2020/05/05/bomblab/1.PNG">

<link rel="canonical" href="http://fentuoli.github.io/2020/05/05/bomblab/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-Hans'
  };
</script>

  <title>bomblab | BoRe</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Navigationsleiste an/ausschalten">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">BoRe</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Startseite</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="archive fa-fw"></i>Archiv</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://fentuoli.github.io/2020/05/05/bomblab/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="般若">
      <meta itemprop="description" content="般若的blog">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="BoRe">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          bomblab
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Veröffentlicht am</span>
              

              <time title="Erstellt: 2020-05-05 14:43:14 / Geändert am: 14:56:22" itemprop="dateCreated datePublished" datetime="2020-05-05T14:43:14+08:00">2020-05-05</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">in</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/csapp/" itemprop="url" rel="index"><span itemprop="name">csapp</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="BOMBLAB"><a href="#BOMBLAB" class="headerlink" title="BOMBLAB"></a><center>BOMBLAB</center></h1><p>说明：CSAPP实验是很有名的实验，我为了完成课堂任务总共写了四个实验：bomblab、cachelab、datalab和malloclab，在做的过程中也参考了许多人的博客，其中主要参考了*<em>码龙的窝： <a href="https://blog.codedragon.tech/about/" target="_blank" rel="noopener">https://blog.codedragon.tech/about/</a> *</em>，在此感谢！</p>
<h2 id="一、实验内容及要求"><a href="#一、实验内容及要求" class="headerlink" title="一、实验内容及要求"></a>一、实验内容及要求</h2><p>Bomb Lab主要是关于反汇编的实验，对应于书本的第三章：程序的机器级表示。</p>
<p>该实验给定了一个二进制程序Bomb（炸弹）。这个炸弹由若干阶段组成，每个阶段都要求你在标准输入流中输入一个字符串，如果字符串正确，那么该阶段就会被解除并且程序会进入下一个阶段。如果字符串错误，那么炸弹会爆炸，并且退出。当每个阶段都被解除后，整个炸弹将会被解除。</p>
<h2 id="二、实验过程分析及截图"><a href="#二、实验过程分析及截图" class="headerlink" title="二、实验过程分析及截图"></a>二、实验过程分析及截图</h2><a id="more"></a>

<h3 id="1-实验准备"><a href="#1-实验准备" class="headerlink" title="1.实验准备"></a>1.实验准备</h3><ul>
<li><p>为获得 bomb 的汇编表示，我们需要使用 objdump 工具执行一条简单的命令：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">objdump -d bomb &gt; bomb.s</span><br></pre></td></tr></table></figure>

<p><img src="/2020/05/05/bomblab/1.PNG" alt="1"></p>
</li>
<li><p>观察符号表可以看到phase_1到phase_6这几个函数以及其他的相关辅助函数，我们需要给每一个阶段的函数添加断点，反汇编，并且理解这些函数的作用，并推测出答案。</p>
</li>
</ul>
<h3 id="2-实验过程"><a href="#2-实验过程" class="headerlink" title="2.实验过程"></a>2.实验过程</h3><ul>
<li><p>main函数：首先在bomb-disassemble中观察main的反汇编代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0000000000400</span>da0 &lt;main&gt;:</span><br><span class="line">  <span class="number">400</span>da0:       <span class="number">53</span>                      push   %rbx</span><br><span class="line">  <span class="number">400</span>da1:       <span class="number">83</span> ff <span class="number">01</span>                cmp    $<span class="number">0x1</span>,%edi</span><br><span class="line">  <span class="number">400</span>da4:       <span class="number">75</span> <span class="number">10</span>                   jne    <span class="number">400</span>db6 &lt;main+<span class="number">0x16</span>&gt;</span><br><span class="line">  <span class="number">400</span>da6:       <span class="number">48</span> <span class="number">8b</span> <span class="number">05</span> <span class="number">9b</span> <span class="number">29</span> <span class="number">20</span> <span class="number">00</span>    mov    <span class="number">0x20299b</span>(%rip),%rax        # <span class="number">603748</span> &lt;<span class="built_in">stdin</span>@@GLIBC_2<span class="number">.2</span><span class="number">.5</span>&gt;</span><br><span class="line">  <span class="number">400</span>dad:       <span class="number">48</span> <span class="number">89</span> <span class="number">05</span> b4 <span class="number">29</span> <span class="number">20</span> <span class="number">00</span>    mov    %rax,<span class="number">0x2029b4</span>(%rip)        # <span class="number">603768</span> &lt;infile&gt;</span><br><span class="line">  <span class="number">400</span>db4:       eb <span class="number">63</span>                   jmp    <span class="number">400e19</span> &lt;main+<span class="number">0x79</span>&gt;</span><br><span class="line">  <span class="number">400</span>db6:       <span class="number">48</span> <span class="number">89</span> f3                mov    %rsi,%rbx</span><br><span class="line">  <span class="number">400</span>db9:       <span class="number">83</span> ff <span class="number">02</span>                cmp    $<span class="number">0x2</span>,%edi</span><br><span class="line">  <span class="number">400</span>dbc:       <span class="number">75</span> <span class="number">3</span>a                   jne    <span class="number">400</span>df8 &lt;main+<span class="number">0x58</span>&gt;</span><br><span class="line">  <span class="number">400</span>dbe:       <span class="number">48</span> <span class="number">8b</span> <span class="number">7</span>e <span class="number">08</span>             mov    <span class="number">0x8</span>(%rsi),%rdi</span><br><span class="line">  <span class="number">400</span>dc2:       be b4 <span class="number">22</span> <span class="number">40</span> <span class="number">00</span>          mov    $<span class="number">0x4022b4</span>,%esi</span><br><span class="line">  <span class="number">400</span>dc7:       e8 <span class="number">44</span> fe ff ff          callq  <span class="number">400</span>c10 &lt;fopen@plt&gt;</span><br><span class="line">  <span class="number">400</span>dcc:       <span class="number">48</span> <span class="number">89</span> <span class="number">05</span> <span class="number">95</span> <span class="number">29</span> <span class="number">20</span> <span class="number">00</span>    mov    %rax,<span class="number">0x202995</span>(%rip)        # <span class="number">603768</span> &lt;infile&gt;</span><br><span class="line">  <span class="number">400</span>dd3:       <span class="number">48</span> <span class="number">85</span> c0                test   %rax,%rax</span><br><span class="line">  <span class="number">400</span>dd6:       <span class="number">75</span> <span class="number">41</span>                   jne    <span class="number">400e19</span> &lt;main+<span class="number">0x79</span>&gt;</span><br><span class="line">  <span class="number">400</span>dd8:       <span class="number">48</span> <span class="number">8b</span> <span class="number">4b</span> <span class="number">08</span>             mov    <span class="number">0x8</span>(%rbx),%rcx</span><br><span class="line">  <span class="number">400</span>ddc:       <span class="number">48</span> <span class="number">8b</span> <span class="number">13</span>                mov    (%rbx),%rdx</span><br><span class="line">  <span class="number">400</span>ddf:       be b6 <span class="number">22</span> <span class="number">40</span> <span class="number">00</span>          mov    $<span class="number">0x4022b6</span>,%esi</span><br><span class="line">  <span class="number">400</span>de4:       bf <span class="number">01</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>          mov    $<span class="number">0x1</span>,%edi</span><br><span class="line">  <span class="number">400</span>de9:       e8 <span class="number">12</span> fe ff ff          callq  <span class="number">400</span>c00 &lt;__printf_chk@plt&gt;</span><br><span class="line">  <span class="number">400</span>dee:       bf <span class="number">08</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>          mov    $<span class="number">0x8</span>,%edi</span><br><span class="line">  <span class="number">400</span>df3:       e8 <span class="number">28</span> fe ff ff          callq  <span class="number">400</span>c20 &lt;<span class="built_in">exit</span>@plt&gt;</span><br><span class="line">  <span class="number">400</span>df8:       <span class="number">48</span> <span class="number">8b</span> <span class="number">16</span>                mov    (%rsi),%rdx</span><br><span class="line">  <span class="number">400</span>dfb:       be d3 <span class="number">22</span> <span class="number">40</span> <span class="number">00</span>          mov    $<span class="number">0x4022d3</span>,%esi</span><br><span class="line">  <span class="number">400e00</span>:       bf <span class="number">01</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>          mov    $<span class="number">0x1</span>,%edi</span><br><span class="line">  <span class="number">400e05</span>:       b8 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>          mov    $<span class="number">0x0</span>,%eax</span><br><span class="line">  <span class="number">400e0</span>a:       e8 f1 fd ff ff          callq  <span class="number">400</span>c00 &lt;__printf_chk@plt&gt;</span><br><span class="line">  <span class="number">400e0</span>f:       bf <span class="number">08</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>          mov    $<span class="number">0x8</span>,%edi</span><br><span class="line">  <span class="number">400e14</span>:       e8 <span class="number">07</span> fe ff ff          callq  <span class="number">400</span>c20 &lt;<span class="built_in">exit</span>@plt&gt;</span><br><span class="line">  <span class="number">400e19</span>:       e8 <span class="number">84</span> <span class="number">05</span> <span class="number">00</span> <span class="number">00</span>          callq  <span class="number">4013</span>a2 &lt;initialize_bomb&gt;</span><br><span class="line">  <span class="number">400e1</span>e:       bf <span class="number">38</span> <span class="number">23</span> <span class="number">40</span> <span class="number">00</span>          mov    $<span class="number">0x402338</span>,%edi</span><br><span class="line">  <span class="number">400e23</span>:       e8 e8 fc ff ff          callq  <span class="number">400b</span>10 &lt;<span class="built_in">puts</span>@plt&gt;</span><br><span class="line">  <span class="number">400e28</span>:       bf <span class="number">78</span> <span class="number">23</span> <span class="number">40</span> <span class="number">00</span>          mov    $<span class="number">0x402378</span>,%edi</span><br><span class="line">  <span class="number">400e2</span>d:       e8 de fc ff ff          callq  <span class="number">400b</span>10 &lt;<span class="built_in">puts</span>@plt&gt;</span><br><span class="line">  <span class="number">400e32</span>:       e8 <span class="number">67</span> <span class="number">06</span> <span class="number">00</span> <span class="number">00</span>          callq  <span class="number">40149</span>e &lt;read_line&gt;</span><br><span class="line">  <span class="number">400e37</span>:       <span class="number">48</span> <span class="number">89</span> c7                mov    %rax,%rdi</span><br><span class="line">  <span class="number">400e3</span>a:       e8 a1 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>          callq  <span class="number">400</span>ee0 &lt;phase_1&gt;</span><br><span class="line">  <span class="number">400e3</span>f:       e8 <span class="number">80</span> <span class="number">07</span> <span class="number">00</span> <span class="number">00</span>          callq  <span class="number">4015</span>c4 &lt;phase_defused&gt;</span><br><span class="line">  <span class="number">400e44</span>:       bf a8 <span class="number">23</span> <span class="number">40</span> <span class="number">00</span>          mov    $<span class="number">0x4023a8</span>,%edi</span><br><span class="line">  <span class="number">400e49</span>:       e8 c2 fc ff ff          callq  <span class="number">400b</span>10 &lt;<span class="built_in">puts</span>@plt&gt;</span><br><span class="line">  <span class="number">400e4</span>e:       e8 <span class="number">4b</span> <span class="number">06</span> <span class="number">00</span> <span class="number">00</span>          callq  <span class="number">40149</span>e &lt;read_line&gt;</span><br><span class="line">  <span class="number">400e53</span>:       <span class="number">48</span> <span class="number">89</span> c7                mov    %rax,%rdi</span><br><span class="line">  <span class="number">400e56</span>:       e8 a1 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>          callq  <span class="number">400</span>efc &lt;phase_2&gt;</span><br><span class="line">  <span class="number">400e5</span>b:       e8 <span class="number">64</span> <span class="number">07</span> <span class="number">00</span> <span class="number">00</span>          callq  <span class="number">4015</span>c4 &lt;phase_defused&gt;</span><br><span class="line">  <span class="number">400e60</span>:       bf ed <span class="number">22</span> <span class="number">40</span> <span class="number">00</span>          mov    $<span class="number">0x4022ed</span>,%edi</span><br><span class="line">  <span class="number">400e65</span>:       e8 a6 fc ff ff          callq  <span class="number">400b</span>10 &lt;<span class="built_in">puts</span>@plt&gt;</span><br><span class="line">  <span class="number">400e6</span>a:       e8 <span class="number">2f</span> <span class="number">06</span> <span class="number">00</span> <span class="number">00</span>          callq  <span class="number">40149</span>e &lt;read_line&gt;</span><br><span class="line">  <span class="number">400e6</span>f:       <span class="number">48</span> <span class="number">89</span> c7                mov    %rax,%rdi</span><br><span class="line">  <span class="number">400e72</span>:       e8 cc <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>          callq  <span class="number">400f</span>43 &lt;phase_3&gt;</span><br><span class="line">  <span class="number">400e77</span>:       e8 <span class="number">48</span> <span class="number">07</span> <span class="number">00</span> <span class="number">00</span>          callq  <span class="number">4015</span>c4 &lt;phase_defused&gt;</span><br><span class="line">  <span class="number">400e7</span>c:       bf <span class="number">0b</span> <span class="number">23</span> <span class="number">40</span> <span class="number">00</span>          mov    $<span class="number">0x40230b</span>,%edi</span><br><span class="line">  <span class="number">400e81</span>:       e8 <span class="number">8</span>a fc ff ff          callq  <span class="number">400b</span>10 &lt;<span class="built_in">puts</span>@plt&gt;</span><br><span class="line">  <span class="number">400e86</span>:       e8 <span class="number">13</span> <span class="number">06</span> <span class="number">00</span> <span class="number">00</span>          callq  <span class="number">40149</span>e &lt;read_line&gt;</span><br><span class="line">  <span class="number">400e8</span>b:       <span class="number">48</span> <span class="number">89</span> c7                mov    %rax,%rdi</span><br><span class="line">  <span class="number">400e8</span>e:       e8 <span class="number">79</span> <span class="number">01</span> <span class="number">00</span> <span class="number">00</span>          callq  <span class="number">40100</span>c &lt;phase_4&gt;</span><br><span class="line">  <span class="number">400e93</span>:       e8 <span class="number">2</span>c <span class="number">07</span> <span class="number">00</span> <span class="number">00</span>          callq  <span class="number">4015</span>c4 &lt;phase_defused&gt;</span><br><span class="line">  <span class="number">400e98</span>:       bf d8 <span class="number">23</span> <span class="number">40</span> <span class="number">00</span>          mov    $<span class="number">0x4023d8</span>,%edi</span><br><span class="line">  <span class="number">400e9</span>d:       e8 <span class="number">6</span>e fc ff ff          callq  <span class="number">400b</span>10 &lt;<span class="built_in">puts</span>@plt&gt;</span><br><span class="line">  <span class="number">400</span>ea2:       e8 f7 <span class="number">05</span> <span class="number">00</span> <span class="number">00</span>          callq  <span class="number">40149</span>e &lt;read_line&gt;</span><br><span class="line">  <span class="number">400</span>ea7:       <span class="number">48</span> <span class="number">89</span> c7                mov    %rax,%rdi</span><br><span class="line">  <span class="number">400</span>eaa:       e8 b3 <span class="number">01</span> <span class="number">00</span> <span class="number">00</span>          callq  <span class="number">401062</span> &lt;phase_5&gt;</span><br><span class="line">  <span class="number">400</span>eaf:       e8 <span class="number">10</span> <span class="number">07</span> <span class="number">00</span> <span class="number">00</span>          callq  <span class="number">4015</span>c4 &lt;phase_defused&gt;</span><br><span class="line">  <span class="number">400</span>eb4:       bf <span class="number">1</span>a <span class="number">23</span> <span class="number">40</span> <span class="number">00</span>          mov    $<span class="number">0x40231a</span>,%edi</span><br><span class="line">  <span class="number">400</span>eb9:       e8 <span class="number">52</span> fc ff ff          callq  <span class="number">400b</span>10 &lt;<span class="built_in">puts</span>@plt&gt;</span><br><span class="line">  <span class="number">400</span>ebe:       e8 db <span class="number">05</span> <span class="number">00</span> <span class="number">00</span>          callq  <span class="number">40149</span>e &lt;read_line&gt;</span><br><span class="line">  <span class="number">400</span>ec3:       <span class="number">48</span> <span class="number">89</span> c7                mov    %rax,%rdi</span><br><span class="line">  <span class="number">400</span>ec6:       e8 <span class="number">29</span> <span class="number">02</span> <span class="number">00</span> <span class="number">00</span>          callq  <span class="number">4010f</span>4 &lt;phase_6&gt;</span><br><span class="line">  <span class="number">400</span>ecb:       e8 f4 <span class="number">06</span> <span class="number">00</span> <span class="number">00</span>          callq  <span class="number">4015</span>c4 &lt;phase_defused&gt;</span><br><span class="line">  <span class="number">400</span>ed0:       b8 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>          mov    $<span class="number">0x0</span>,%eax</span><br><span class="line">  <span class="number">400</span>ed5:       <span class="number">5b</span>                      pop    %rbx</span><br><span class="line">  <span class="number">400</span>ed6:       c3                      retq   </span><br></pre></td></tr></table></figure>

<p>分析：结合bomb.c可以得出，main函数每次调用read_line从标准输入流中读入一行字符串，并将其返回值（即字符串的首地址）设置为第一个参数，然后依次调用phase_1到phase_6。</p>
<p>在每一个phase函数内部检查输入的字符串是否正确，如果不正确，则调用explode_bomb函数引爆bomb；否则则返回，返回之后由主函数再继续调用phase_defused解除该阶段。</p>
<p>因此，在每一个阶段中，我们关注的重点应当是phase函数内部以及phase函数所调用的其他函数。</p>
</li>
<li><p>phase_1:</p>
<p>在bomb-disassemble中观察phase_1的反汇编代码:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0000000000400</span>ee0 &lt;phase_1&gt;:</span><br><span class="line">  <span class="number">400</span>ee0:       <span class="number">48</span> <span class="number">83</span> ec <span class="number">08</span>             sub    $<span class="number">0x8</span>,%rsp</span><br><span class="line">  <span class="number">400</span>ee4:       be <span class="number">00</span> <span class="number">24</span> <span class="number">40</span> <span class="number">00</span>          mov    $<span class="number">0x402400</span>,%esi #设置第二个参数为指针</span><br><span class="line">  <span class="number">400</span>ee9:       e8 <span class="number">4</span>a <span class="number">04</span> <span class="number">00</span> <span class="number">00</span>          callq  <span class="number">401338</span> &lt;strings_not_equal&gt; #调用strings_not_equal函数</span><br><span class="line">  <span class="number">400</span>eee:       <span class="number">85</span> c0                   test   %eax,%eax</span><br><span class="line">  <span class="number">400</span>ef0:       <span class="number">74</span> <span class="number">05</span>                   je     <span class="number">400</span>ef7 &lt;phase_1+<span class="number">0x17</span>&gt;</span><br><span class="line">  <span class="number">400</span>ef2:       e8 <span class="number">43</span> <span class="number">05</span> <span class="number">00</span> <span class="number">00</span>          callq  <span class="number">40143</span>a &lt;explode_bomb&gt; #若返回值不为<span class="number">0</span>则引爆bomb</span><br><span class="line">  <span class="number">400</span>ef7:       <span class="number">48</span> <span class="number">83</span> c4 <span class="number">08</span>             add    $<span class="number">0x8</span>,%rsp</span><br><span class="line">  <span class="number">400</span>efb:       c3                      retq  </span><br><span class="line"> </span><br></pre></td></tr></table></figure>

<p>分析：</p>
<p>可以看出，phase_1调用了strings_not_equal这个函数，并为该函数配置了第二个参数0x402400，并判断该函数的返回值是否为0，如果为0则返回，否则引爆bomb。</p>
</li>
</ul>
<p>  从函数名可以推测，该函数的作用是判断两个字符串是否不相同，如果不相同，则返回非0值，相同则返回0。</p>
<p>  还可以推测，该函数的第一个参数%rsp中存放了我们输入的字符串的首地址，而第二个参数%esi指向了待比较的字符串的首地址——也就是阶段1的答案。</p>
<p>  所以我们使用 GDB 查看这个地址中的内容。</p>
<p>  <img src="/2020/05/05/bomblab/2.PNG" alt="2"></p>
<p>  我们已经得到了phase_1的答案，就是”Border relations with Canada have never been better.”</p>
<ul>
<li><p>phase_2:</p>
<p>在bomb-disassemble中观察phase_2的反汇编代码:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0000000000400</span>efc &lt;phase_2&gt;:</span><br><span class="line">  <span class="number">400</span>efc:       <span class="number">55</span>                      push   %rbp</span><br><span class="line">  <span class="number">400</span>efd:       <span class="number">53</span>                      push   %rbx</span><br><span class="line">  <span class="number">400</span>efe:       <span class="number">48</span> <span class="number">83</span> ec <span class="number">28</span>             sub    $<span class="number">0x28</span>,%rsp</span><br><span class="line">  <span class="number">400f</span>02:       <span class="number">48</span> <span class="number">89</span> e6                mov    %rsp,%rsi</span><br><span class="line">  <span class="number">400f</span>05:       e8 <span class="number">52</span> <span class="number">05</span> <span class="number">00</span> <span class="number">00</span>          callq  <span class="number">40145</span>c &lt;read_six_numbers&gt; #从输入的字符串中读入<span class="number">6</span>个数字</span><br><span class="line">  <span class="number">400f</span>0a:       <span class="number">83</span> <span class="number">3</span>c <span class="number">24</span> <span class="number">01</span>             cmpl   $<span class="number">0x1</span>,(%rsp)</span><br><span class="line">  <span class="number">400f</span>0e:       <span class="number">74</span> <span class="number">20</span>                   je     <span class="number">400f</span>30 &lt;phase_2+<span class="number">0x34</span>&gt;</span><br><span class="line">  <span class="number">400f</span>10:       e8 <span class="number">25</span> <span class="number">05</span> <span class="number">00</span> <span class="number">00</span>          callq  <span class="number">40143</span>a &lt;explode_bomb&gt; #如果第一个数字不为<span class="number">1</span>则引爆炸弹</span><br><span class="line">  <span class="number">400f</span>15:       eb <span class="number">19</span>                   jmp    <span class="number">400f</span>30 &lt;phase_2+<span class="number">0x34</span>&gt;</span><br><span class="line">  <span class="number">400f</span>17:       <span class="number">8b</span> <span class="number">43</span> fc                mov    <span class="number">-0x4</span>(%rbx),%eax</span><br><span class="line">  <span class="number">400f</span>1a:       <span class="number">01</span> c0                   add    %eax,%eax</span><br><span class="line">  # 计算前一个元素*<span class="number">2</span></span><br><span class="line">  <span class="number">400f</span>1c:       <span class="number">39</span> <span class="number">03</span>                   cmp    %eax,(%rbx)</span><br><span class="line">  <span class="number">400f</span>1e:       <span class="number">74</span> <span class="number">05</span>                   je     <span class="number">400f</span>25 &lt;phase_2+<span class="number">0x29</span>&gt;</span><br><span class="line">  <span class="number">400f</span>20:       e8 <span class="number">15</span> <span class="number">05</span> <span class="number">00</span> <span class="number">00</span>          callq  <span class="number">40143</span>a &lt;explode_bomb&gt; #若当前元素不等于前一个元素*<span class="number">2</span>则引爆bomb</span><br><span class="line">  <span class="number">400f</span>25:       <span class="number">48</span> <span class="number">83</span> c3 <span class="number">04</span>             add    $<span class="number">0x4</span>,%rbx</span><br><span class="line">  <span class="number">400f</span>29:       <span class="number">48</span> <span class="number">39</span> eb                cmp    %rbp,%rbx</span><br><span class="line">  <span class="number">400f</span>2c:       <span class="number">75</span> e9                   jne    <span class="number">400f</span>17 &lt;phase_2+<span class="number">0x1b</span>&gt;</span><br><span class="line">  # 指向下一个元素</span><br><span class="line">  <span class="number">400f</span>2e:       eb <span class="number">0</span>c                   jmp    <span class="number">400f</span>3c &lt;phase_2+<span class="number">0x40</span>&gt;</span><br><span class="line">  <span class="number">400f</span>30:       <span class="number">48</span> <span class="number">8</span>d <span class="number">5</span>c <span class="number">24</span> <span class="number">04</span>          lea    <span class="number">0x4</span>(%rsp),%rbx</span><br><span class="line">  <span class="number">400f</span>35:       <span class="number">48</span> <span class="number">8</span>d <span class="number">6</span>c <span class="number">24</span> <span class="number">18</span>          lea    <span class="number">0x18</span>(%rsp),%rbp #设置b和bEnd</span><br><span class="line">  <span class="number">400f</span>3a:       eb db                   jmp    <span class="number">400f</span>17 &lt;phase_2+<span class="number">0x1b</span>&gt;</span><br><span class="line">  <span class="number">400f</span>3c:       <span class="number">48</span> <span class="number">83</span> c4 <span class="number">28</span>             add    $<span class="number">0x28</span>,%rsp</span><br><span class="line">  <span class="number">400f</span>40:       <span class="number">5b</span>                      pop    %rbx</span><br><span class="line">  <span class="number">400f</span>41:       <span class="number">5</span>d                      pop    %rbp</span><br><span class="line">  <span class="number">400f</span>42:       c3                      retq   </span><br></pre></td></tr></table></figure>

<p>可以看出，在phase_2的一开始调用了read_six_numbers这个函数，初步推测这是用来从输入字符串中读取六个数字的函数，其将输入字符串的地址作为第一个参数，将栈顶指针%rsp作为第二个参数，下面我们查看read_six_numbers的反汇编代码:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">000000000040145</span>c &lt;read_six_numbers&gt;:</span><br><span class="line">  <span class="number">40145</span>c:       <span class="number">48</span> <span class="number">83</span> ec <span class="number">18</span>             sub    $<span class="number">0x18</span>,%rsp</span><br><span class="line">  <span class="number">401460</span>:       <span class="number">48</span> <span class="number">89</span> f2                mov    %rsi,%rdx</span><br><span class="line">  <span class="number">401463</span>:       <span class="number">48</span> <span class="number">8</span>d <span class="number">4</span>e <span class="number">04</span>             lea    <span class="number">0x4</span>(%rsi),%rcx</span><br><span class="line">  <span class="number">401467</span>:       <span class="number">48</span> <span class="number">8</span>d <span class="number">46</span> <span class="number">14</span>             lea    <span class="number">0x14</span>(%rsi),%rax</span><br><span class="line">  <span class="number">40146b</span>:       <span class="number">48</span> <span class="number">89</span> <span class="number">44</span> <span class="number">24</span> <span class="number">08</span>          mov    %rax,<span class="number">0x8</span>(%rsp)</span><br><span class="line">  <span class="number">401470</span>:       <span class="number">48</span> <span class="number">8</span>d <span class="number">46</span> <span class="number">10</span>             lea    <span class="number">0x10</span>(%rsi),%rax</span><br><span class="line">  <span class="number">401474</span>:       <span class="number">48</span> <span class="number">89</span> <span class="number">04</span> <span class="number">24</span>             mov    %rax,(%rsp)</span><br><span class="line">  <span class="number">401478</span>:       <span class="number">4</span>c <span class="number">8</span>d <span class="number">4</span>e <span class="number">0</span>c             lea    <span class="number">0xc</span>(%rsi),%r9</span><br><span class="line">  <span class="number">40147</span>c:       <span class="number">4</span>c <span class="number">8</span>d <span class="number">46</span> <span class="number">08</span>             lea    <span class="number">0x8</span>(%rsi),%r8</span><br><span class="line">  <span class="number">401480</span>:       be c3 <span class="number">25</span> <span class="number">40</span> <span class="number">00</span>          mov    $<span class="number">0x4025c3</span>,%esi</span><br><span class="line">  <span class="number">401485</span>:       b8 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>          mov    $<span class="number">0x0</span>,%eax</span><br><span class="line">  # 为<span class="built_in">sscanf</span>配置参数</span><br><span class="line">  <span class="number">40148</span>a:       e8 <span class="number">61</span> f7 ff ff          callq  <span class="number">400b</span>f0 &lt;__isoc99_sscanf@plt&gt;</span><br><span class="line">  # 调用<span class="built_in">sscanf</span>(input, <span class="string">"%d %d %d %d %d %d"</span>, &amp;a[<span class="number">0</span>], &amp;a[<span class="number">1</span>], &amp;a[<span class="number">2</span>], &amp;a[<span class="number">3</span>], &amp;a[<span class="number">4</span>], &amp;a[<span class="number">5</span>]);</span><br><span class="line">  <span class="number">40148f</span>:       <span class="number">83</span> f8 <span class="number">05</span>                cmp    $<span class="number">0x5</span>,%eax</span><br><span class="line">  <span class="number">401492</span>:       <span class="number">7f</span> <span class="number">05</span>                   jg     <span class="number">401499</span> &lt;read_six_numbers+<span class="number">0x3d</span>&gt;</span><br><span class="line">  <span class="number">401494</span>:       e8 a1 ff ff ff          callq  <span class="number">40143</span>a &lt;explode_bomb&gt; #若读取成功的数字数小于<span class="number">6</span>则引爆bomb</span><br><span class="line">  <span class="number">401499</span>:       <span class="number">48</span> <span class="number">83</span> c4 <span class="number">18</span>             add    $<span class="number">0x18</span>,%rsp</span><br><span class="line">  <span class="number">40149</span>d:       c3                      retq   </span><br></pre></td></tr></table></figure>

<p>可以看出，该函数在0x401460-0x401480为函数的调用构造了参数，在0x401485将返回值置0，并在0x40148a处调用了sscanf函数。并且检查sscanf函数的返回值（读取成功的变量个数），如果返回值&lt;=5，则引爆bomb，否则则正确返回。</p>
</li>
</ul>
<p>  下面我们重点观察调用函数的参数构造过程。%rdi是第1个参数，指向了输入的字符串，推测第2个参数%rsi应该指向了格式化字符串的首地址，且该字符串为”%d %d %d %d %d %d”。%rdx是第3个参数，为%rsi+0，%rcx是第4个参数，为%rsi+4，%r8是第5个参数，为%rsi+8，%r9是第6个参数，为%rsi+12。(%rsp)是第7个参数，为%rsi+16，(%rsp+8)是第8个参数，为%rsi+20。</p>
<p>  可以归纳出read_six_numbers接收2个参数，其中第1个参数为输入字符串的首地址，第2个参数为6元素的int型数组的首地址，该函数从输入字符串中读取6个数字，并且将这6个数字存入第2个参数所指向的int型数组中。但如果读取的数字不足6个，则会引爆bomb。</p>
<p>  然后我们回到phase_2函数中，将phase_2函数逆向，可以得到如下的结果：</p>
  <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">phase_2</span><span class="params">(<span class="keyword">char</span> * input)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">int</span> a[<span class="number">6</span>];</span><br><span class="line">	read_six_numbers(input, a);</span><br><span class="line">	<span class="keyword">if</span> (a[<span class="number">0</span>] == <span class="number">1</span>) explode_bomb();</span><br><span class="line">	<span class="keyword">int</span> * b = &amp;a[<span class="number">1</span>], * bEnd = &amp;a[<span class="number">6</span>];</span><br><span class="line">	<span class="keyword">do</span> &#123;</span><br><span class="line">		<span class="keyword">int</span> val = (*(b<span class="number">-1</span>)) * <span class="number">2</span>;</span><br><span class="line">		<span class="keyword">if</span> (*b != val) explode_bomb();</span><br><span class="line">		b++;</span><br><span class="line">	&#125; <span class="keyword">while</span> (b != bEnd);</span><br><span class="line">	<span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>  上述代码依次检查了读入的6个数字，第1个数字必须为1，从第2个数字开始，每一个数字都必须是上一个数字的两倍，否则将会引爆bomb。显然，phase_2的答案为”1 2 4 8 16 32”。</p>
<p>  <img src="/2020/05/05/bomblab/3.PNG" alt="3"></p>
<ul>
<li><p>phase_3:</p>
<p>在bomb-disassemble中观察phase_3的反汇编代码:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0000000000400f</span>43 &lt;phase_3&gt;:</span><br><span class="line">  <span class="number">400f</span>43: sub    $<span class="number">0x18</span>,%rsp</span><br><span class="line">  <span class="number">400f</span>47: lea    <span class="number">0xc</span>(%rsp),%rcx</span><br><span class="line">  <span class="number">400f</span>4c: lea    <span class="number">0x8</span>(%rsp),%rdx</span><br><span class="line">  <span class="number">400f</span>51: mov    $<span class="number">0x4025cf</span>,%esi                     # 又是一个字符串，可以用 gdb 查看，得到`<span class="string">"%d %d"</span>, 格式化字符串，说明输入两个数字</span><br><span class="line">  <span class="number">400f</span>56: mov    $<span class="number">0x0</span>,%eax</span><br><span class="line">  <span class="number">400f</span>5b: callq  <span class="number">400b</span>f0 &lt;__isoc99_sscanf@plt&gt;       # 输入</span><br><span class="line">  <span class="number">400f</span>60: cmp    $<span class="number">0x1</span>,%eax                           # 判断输入成功</span><br><span class="line">  <span class="number">400f</span>63: jg     <span class="number">400f</span>6a &lt;phase_3+<span class="number">0x27</span>&gt;</span><br><span class="line">  <span class="number">400f</span>65: callq  <span class="number">40143</span>a &lt;explode_bomb&gt;</span><br><span class="line">  <span class="number">400f</span>6a: cmpl   $<span class="number">0x7</span>,<span class="number">0x8</span>(%rsp)                       # 第一个参数是否小于等于 <span class="number">7</span>, 大于则 boom</span><br><span class="line">  <span class="number">400f</span>6f: ja     <span class="number">400f</span>ad &lt;phase_3+<span class="number">0x6a</span>&gt;</span><br><span class="line">  <span class="number">400f</span>71: mov    <span class="number">0x8</span>(%rsp),%eax</span><br><span class="line">  <span class="number">400f</span>75: jmpq   *<span class="number">0x402470</span>(,%rax,<span class="number">8</span>)                 # 以下是 <span class="keyword">switch</span>, 根据 rax, 即第一个输入的参数跳转</span><br><span class="line">  <span class="number">400f</span>7c: mov    $<span class="number">0xcf</span>,%eax                          # 由此容易得到答案，比如这里是 rax=<span class="number">0</span> 时，则 另一个参数为 <span class="number">0xcf</span>  = <span class="number">207</span></span><br><span class="line">  <span class="number">400f</span>81: jmp    <span class="number">400f</span>be &lt;phase_3+<span class="number">0x7b</span>&gt;</span><br><span class="line">  <span class="number">400f</span>83: mov    $<span class="number">0x2c3</span>,%eax</span><br><span class="line">  <span class="number">400f</span>88: jmp    <span class="number">400f</span>be &lt;phase_3+<span class="number">0x7b</span>&gt;</span><br><span class="line">  <span class="number">400f</span>8a: mov    $<span class="number">0x100</span>,%eax</span><br><span class="line">  <span class="number">400f</span>8f: jmp    <span class="number">400f</span>be &lt;phase_3+<span class="number">0x7b</span>&gt;</span><br><span class="line">  <span class="number">400f</span>91: mov    $<span class="number">0x185</span>,%eax</span><br><span class="line">  <span class="number">400f</span>96: jmp    <span class="number">400f</span>be &lt;phase_3+<span class="number">0x7b</span>&gt;</span><br><span class="line">  <span class="number">400f</span>98: mov    $<span class="number">0xce</span>,%eax</span><br><span class="line">  <span class="number">400f</span>9d: jmp    <span class="number">400f</span>be &lt;phase_3+<span class="number">0x7b</span>&gt;</span><br><span class="line">  <span class="number">400f</span>9f: mov    $<span class="number">0x2aa</span>,%eax</span><br><span class="line">  <span class="number">400f</span>a4: jmp    <span class="number">400f</span>be &lt;phase_3+<span class="number">0x7b</span>&gt;</span><br><span class="line">  <span class="number">400f</span>a6: mov    $<span class="number">0x147</span>,%eax</span><br><span class="line">  <span class="number">400f</span>ab: jmp    <span class="number">400f</span>be &lt;phase_3+<span class="number">0x7b</span>&gt;</span><br><span class="line">  <span class="number">400f</span>ad: callq  <span class="number">40143</span>a &lt;explode_bomb&gt;</span><br><span class="line">  <span class="number">400f</span>b2: mov    $<span class="number">0x0</span>,%eax</span><br><span class="line">  <span class="number">400f</span>b7: jmp    <span class="number">400f</span>be &lt;phase_3+<span class="number">0x7b</span>&gt;</span><br><span class="line">  <span class="number">400f</span>b9: mov    $<span class="number">0x137</span>,%eax</span><br><span class="line">  <span class="number">400f</span>be: cmp    <span class="number">0xc</span>(%rsp),%eax</span><br><span class="line">  <span class="number">400f</span>c2: je     <span class="number">400f</span>c9 &lt;phase_3+<span class="number">0x86</span>&gt;</span><br><span class="line">  <span class="number">400f</span>c4: callq  <span class="number">40143</span>a &lt;explode_bomb&gt;</span><br><span class="line">  <span class="number">400f</span>c9: add    $<span class="number">0x18</span>,%rsp</span><br><span class="line">  <span class="number">400f</span>cd: retq</span><br></pre></td></tr></table></figure>

<p>推测phase_3的一开始用sscanf从输入字符串中读入了2个int型数字。</p>
<p>然后观察phase_3中的jmpq ×0x402470(,%rax,8)以及下面的mov与jmp指令，基本上可以肯定这是使用跳转表实现的switch语句。</p>
<p>下面在GDB中验证并记录不同%rax的值对应跳转表的不同跳转位置。</p>
<p><img src="/2020/05/05/bomblab/17.PNG" alt="17"></p>
<p>从GDB运行的结果可以看出，sscanf确实读入了两个int *数字，并且也得到了所有的%rax对应的跳转表的不同跳转位置。</p>
<p>将phase_3函数逆向，得到如下的结果：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">phase_3</span><span class="params">(<span class="keyword">char</span> * input)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">int</span> a, b;</span><br><span class="line">	<span class="keyword">int</span> val = <span class="built_in">sscanf</span>(input, <span class="string">"%d %d"</span>, &amp;a, &amp;b);</span><br><span class="line">	<span class="keyword">if</span> (val &lt;= <span class="number">1</span>) explode_bomb();</span><br><span class="line">	<span class="keyword">switch</span> (a) &#123;</span><br><span class="line">	<span class="keyword">case</span> <span class="number">0</span>: a = <span class="number">207</span>; <span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> <span class="number">1</span>: a = <span class="number">311</span>; <span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> <span class="number">2</span>: a = <span class="number">707</span>; <span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> <span class="number">3</span>: a = <span class="number">256</span>; <span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> <span class="number">4</span>: a = <span class="number">389</span>; <span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> <span class="number">5</span>: a = <span class="number">206</span>; <span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> <span class="number">6</span>: a = <span class="number">682</span>; <span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> <span class="number">7</span>: a = <span class="number">327</span>; <span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">default</span>: explode_bomb(); a = <span class="number">0</span>; <span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (a != b) explode_bomb();</span><br><span class="line">	<span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br></pre></td></tr></table></figure>

<p>根据逆向的结果，我们可以得知，本阶段要求输入2个数，且第1个数只能为0到7，且根据第1个数取值的不同，满足条件的第2个数的取值也不同,可得跳转表如下：<br>%rax 跳转地址 0xc(%rsp)<br>0 0x0000000000400f7c 0xcf 207<br>1 0x0000000000400fb9 0x137 311<br>2 0x0000000000400f83 0x2c3 707<br>3 0x0000000000400f8a 0x100 256<br>4 0x0000000000400f91 0x185 389<br>5 0x0000000000400f98 0xce 206<br>6 0x0000000000400f9f 0x2aa 682<br>7 0x0000000000400fa6 0x147 327</p>
<p><img src="/2020/05/05/bomblab/4.PNG" alt="4"></p>
</li>
<li><p>phase_4:</p>
<p>在bomb-disassemble中观察phase_4的反汇编代码:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">000000000040100</span>c &lt;phase_4&gt;:</span><br><span class="line">  <span class="number">40100</span>c:       <span class="number">48</span> <span class="number">83</span> ec <span class="number">18</span>             sub    $<span class="number">0x18</span>,%rsp</span><br><span class="line">  <span class="number">401010</span>:       <span class="number">48</span> <span class="number">8</span>d <span class="number">4</span>c <span class="number">24</span> <span class="number">0</span>c          lea    <span class="number">0xc</span>(%rsp),%rcx</span><br><span class="line">  <span class="number">401015</span>:       <span class="number">48</span> <span class="number">8</span>d <span class="number">54</span> <span class="number">24</span> <span class="number">08</span>          lea    <span class="number">0x8</span>(%rsp),%rdx</span><br><span class="line">  <span class="number">40101</span>a:       be cf <span class="number">25</span> <span class="number">40</span> <span class="number">00</span>          mov    $<span class="number">0x4025cf</span>,%esi</span><br><span class="line">  <span class="number">40101f</span>:       b8 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>          mov    $<span class="number">0x0</span>,%eax</span><br><span class="line">  <span class="number">401024</span>:       e8 c7 fb ff ff          callq  <span class="number">400b</span>f0 &lt;__isoc99_sscanf@plt&gt; # 从输入的字符串中读取两个数字 并存入局部变量中</span><br><span class="line">  <span class="number">401029</span>:       <span class="number">83</span> f8 <span class="number">02</span>                cmp    $<span class="number">0x2</span>,%eax</span><br><span class="line">  <span class="number">40102</span>c:       <span class="number">75</span> <span class="number">07</span>                   jne    <span class="number">401035</span> &lt;phase_4+<span class="number">0x29</span>&gt; # 若数字不为两个 则引爆bomb</span><br><span class="line">  <span class="number">40102</span>e:       <span class="number">83</span> <span class="number">7</span>c <span class="number">24</span> <span class="number">08</span> <span class="number">0</span>e          cmpl   $<span class="number">0xe</span>,<span class="number">0x8</span>(%rsp)</span><br><span class="line">  <span class="number">401033</span>:       <span class="number">76</span> <span class="number">05</span>                   jbe    <span class="number">40103</span>a &lt;phase_4+<span class="number">0x2e</span>&gt; # 若第一个数字大于<span class="number">14</span> 则引爆bomb</span><br><span class="line">  <span class="number">401035</span>:       e8 <span class="number">00</span> <span class="number">04</span> <span class="number">00</span> <span class="number">00</span>          callq  <span class="number">40143</span>a &lt;explode_bomb&gt;</span><br><span class="line">  <span class="number">40103</span>a:       ba <span class="number">0</span>e <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>          mov    $<span class="number">0xe</span>,%edx</span><br><span class="line">  <span class="number">40103f</span>:       be <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>          mov    $<span class="number">0x0</span>,%esi</span><br><span class="line">  <span class="number">401044</span>:       <span class="number">8b</span> <span class="number">7</span>c <span class="number">24</span> <span class="number">08</span>             mov    <span class="number">0x8</span>(%rsp),%edi</span><br><span class="line">  <span class="number">401048</span>:       e8 <span class="number">81</span> ff ff ff          callq  <span class="number">400f</span>ce &lt;func4&gt; # 调用func4</span><br><span class="line">  <span class="number">40104</span>d:       <span class="number">85</span> c0                   test   %eax,%eax</span><br><span class="line">  <span class="number">40104f</span>:       <span class="number">75</span> <span class="number">07</span>                   jne    <span class="number">401058</span> &lt;phase_4+<span class="number">0x4c</span>&gt;</span><br><span class="line">  <span class="number">401051</span>:       <span class="number">83</span> <span class="number">7</span>c <span class="number">24</span> <span class="number">0</span>c <span class="number">00</span>          cmpl   $<span class="number">0x0</span>,<span class="number">0xc</span>(%rsp)</span><br><span class="line">  <span class="number">401056</span>:       <span class="number">74</span> <span class="number">05</span>                   je     <span class="number">40105</span>d &lt;phase_4+<span class="number">0x51</span>&gt; # 当返回值和b均为<span class="number">0</span>时 解除阶段 否则 引爆bomb</span><br><span class="line">  <span class="number">401058</span>:       e8 dd <span class="number">03</span> <span class="number">00</span> <span class="number">00</span>          callq  <span class="number">40143</span>a &lt;explode_bomb&gt;</span><br><span class="line">  <span class="number">40105</span>d:       <span class="number">48</span> <span class="number">83</span> c4 <span class="number">18</span>             add    $<span class="number">0x18</span>,%rsp</span><br><span class="line">  <span class="number">401061</span>:       c3  </span><br><span class="line"> </span><br></pre></td></tr></table></figure>

<p>可以注意到，phase_4的反汇编代码前半部分与phase_3相似，均是从输入的字符串中读入2个数字。</p>
<p>将phase_4逆向，得到如下的结果：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">phase_4</span><span class="params">(<span class="keyword">char</span> * input)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">int</span> a, b;</span><br><span class="line">	<span class="keyword">int</span> val = <span class="built_in">sscanf</span>(input, <span class="string">"%d %d"</span>, &amp;a, &amp;b);</span><br><span class="line">	<span class="keyword">if</span> (val != <span class="number">2</span> || ((<span class="keyword">unsigned</span>)a &gt; <span class="number">14</span>)) explode_bomb();</span><br><span class="line">	val = func4(a, <span class="number">0</span>, <span class="number">14</span>);</span><br><span class="line">	<span class="keyword">if</span> (val != <span class="number">0</span> || b != <span class="number">0</span>) explode_bomb();</span><br><span class="line">	<span class="keyword">return</span>;</span><br><span class="line"> </span><br></pre></td></tr></table></figure>

<p>从逆向的结果我们可以看出，phase_4从输入的字符串中读入2个数字a和b，并且a必须小于等于14且大于等于0，然后phase_4调用func4(a, 0, 14)，且只有该函数的返回值和b均为0时，该阶段解除。</p>
<p>下面查看func4的反汇编代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0000000000400f</span>ce &lt;func4&gt;:</span><br><span class="line">  <span class="number">400f</span>ce:       <span class="number">48</span> <span class="number">83</span> ec <span class="number">08</span>             sub    $<span class="number">0x8</span>,%rsp</span><br><span class="line">  <span class="number">400f</span>d2:       <span class="number">89</span> d0                   mov    %edx,%eax</span><br><span class="line">  <span class="number">400f</span>d4:       <span class="number">29</span> f0                   sub    %esi,%eax</span><br><span class="line">  <span class="number">400f</span>d6:       <span class="number">89</span> c1                   mov    %eax,%ecx</span><br><span class="line">  <span class="number">400f</span>d8:       c1 e9 <span class="number">1f</span>                shr    $<span class="number">0x1f</span>,%ecx</span><br><span class="line">  <span class="number">400f</span>db:       <span class="number">01</span> c8                   add    %ecx,%eax</span><br><span class="line">  <span class="number">400f</span>dd:       d1 f8                   sar    %eax</span><br><span class="line">  # 实际上是/<span class="number">2</span>过程，为了保证负数时舍入正确才使用了位移</span><br><span class="line">  <span class="number">400f</span>df:       <span class="number">8</span>d <span class="number">0</span>c <span class="number">30</span>                lea    (%rax,%rsi,<span class="number">1</span>),%ecx</span><br><span class="line">  # %rax加上b</span><br><span class="line">  <span class="number">400f</span>e2:       <span class="number">39</span> f9                   cmp    %edi,%ecx</span><br><span class="line">  <span class="number">400f</span>e4:       <span class="number">7</span>e <span class="number">0</span>c                   jle    <span class="number">400f</span>f2 &lt;func4+<span class="number">0x24</span>&gt;</span><br><span class="line">  <span class="meta"># <span class="meta-keyword">if</span>分支</span></span><br><span class="line">  <span class="number">400f</span>e6:       <span class="number">8</span>d <span class="number">51</span> ff                lea    <span class="number">-0x1</span>(%rcx),%edx</span><br><span class="line">  <span class="number">400f</span>e9:       e8 e0 ff ff ff          callq  <span class="number">400f</span>ce &lt;func4&gt;</span><br><span class="line">  # 递归过程</span><br><span class="line">  <span class="number">400f</span>ee:       <span class="number">01</span> c0                   add    %eax,%eax</span><br><span class="line">  <span class="number">400f</span>f0:       eb <span class="number">15</span>                   jmp    <span class="number">401007</span> &lt;func4+<span class="number">0x39</span>&gt;</span><br><span class="line">  <span class="number">400f</span>f2:       b8 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>          mov    $<span class="number">0x0</span>,%eax</span><br><span class="line">  <span class="number">400f</span>f7:       <span class="number">39</span> f9                   cmp    %edi,%ecx</span><br><span class="line">  <span class="number">400f</span>f9:       <span class="number">7</span>d <span class="number">0</span>c                   jge    <span class="number">401007</span> &lt;func4+<span class="number">0x39</span>&gt;</span><br><span class="line">  <span class="number">400f</span>fb:       <span class="number">8</span>d <span class="number">71</span> <span class="number">01</span>                lea    <span class="number">0x1</span>(%rcx),%esi</span><br><span class="line">  <span class="number">400f</span>fe:       e8 cb ff ff ff          callq  <span class="number">400f</span>ce &lt;func4&gt;</span><br><span class="line">  # 递归过程</span><br><span class="line">  <span class="number">401003</span>:       <span class="number">8</span>d <span class="number">44</span> <span class="number">00</span> <span class="number">01</span>             lea    <span class="number">0x1</span>(%rax,%rax,<span class="number">1</span>),%eax</span><br><span class="line">  <span class="number">401007</span>:       <span class="number">48</span> <span class="number">83</span> c4 <span class="number">08</span>             add    $<span class="number">0x8</span>,%rsp</span><br><span class="line">  <span class="number">40100b</span>:       c3                      retq   </span><br><span class="line"> </span><br></pre></td></tr></table></figure>

<p>观察反汇编的func4函数，发现func4函数中调用了func4函数自身，由此可以推测func4函数是一个递归过程。</p>
<p>将func4逆向，得到如下的结果：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">func4</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b, <span class="keyword">int</span> c)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">int</span> returnVal = (c - b) / <span class="number">2</span>;</span><br><span class="line">	<span class="keyword">int</span> val = returnVal + b;</span><br><span class="line">	<span class="keyword">if</span> (val == a) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">if</span> (val &lt; a) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">2</span> * func4(a, val + <span class="number">1</span>, c) + <span class="number">1</span>;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">2</span> * func4(a, b, val - <span class="number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>观察func4的逆向结果，我们可以发现func4非常类似于二分查找的过程。要另func4的返回值为0，则一定不能让func4执行val&lt;a的分支即必须一直保证(b+c)/2 &gt;= a。考虑到0&lt;=a&lt;=14，所以满足条件的a有a=7 a=3 a=1 a=0 共4个。</p>
<p><img src="/2020/05/05/bomblab/5.PNG" alt="5"></p>
</li>
<li><p>phase_5:</p>
<p>在bomb-disassemble中观察phase_5的反汇编代码:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0000000000401062</span> &lt;phase_5&gt;:</span><br><span class="line">  <span class="number">401062</span>:       <span class="number">53</span>                      push   %rbx</span><br><span class="line">  <span class="number">401063</span>:       <span class="number">48</span> <span class="number">83</span> ec <span class="number">20</span>             sub    $<span class="number">0x20</span>,%rsp</span><br><span class="line">  <span class="number">401067</span>:       <span class="number">48</span> <span class="number">89</span> fb                mov    %rdi,%rbx</span><br><span class="line">  <span class="number">40106</span>a:       <span class="number">64</span> <span class="number">48</span> <span class="number">8b</span> <span class="number">04</span> <span class="number">25</span> <span class="number">28</span> <span class="number">00</span>    mov    %fs:<span class="number">0x28</span>,%rax</span><br><span class="line">  <span class="number">401071</span>:       <span class="number">00</span> <span class="number">00</span></span><br><span class="line">  # 栈破坏检测机制</span><br><span class="line">  <span class="number">401073</span>:       <span class="number">48</span> <span class="number">89</span> <span class="number">44</span> <span class="number">24</span> <span class="number">18</span>          mov    %rax,<span class="number">0x18</span>(%rsp)</span><br><span class="line">  <span class="number">401078</span>:       <span class="number">31</span> c0                   <span class="keyword">xor</span>    %eax,%eax</span><br><span class="line">  <span class="number">40107</span>a:       e8 <span class="number">9</span>c <span class="number">02</span> <span class="number">00</span> <span class="number">00</span>          callq  <span class="number">40131b</span> &lt;string_length&gt;</span><br><span class="line">  # 计算输入字符串长度</span><br><span class="line">  <span class="number">40107f</span>:       <span class="number">83</span> f8 <span class="number">06</span>                cmp    $<span class="number">0x6</span>,%eax</span><br><span class="line">  <span class="number">401082</span>:       <span class="number">74</span> <span class="number">4</span>e                   je     <span class="number">4010</span>d2 &lt;phase_5+<span class="number">0x70</span>&gt;</span><br><span class="line">  # 若长度不为<span class="number">6</span> 则引爆bomb</span><br><span class="line">  <span class="number">401084</span>:       e8 b1 <span class="number">03</span> <span class="number">00</span> <span class="number">00</span>          callq  <span class="number">40143</span>a &lt;explode_bomb&gt;</span><br><span class="line">  <span class="number">401089</span>:       eb <span class="number">47</span>                   jmp    <span class="number">4010</span>d2 &lt;phase_5+<span class="number">0x70</span>&gt;</span><br><span class="line">  <span class="number">40108b</span>:       <span class="number">0f</span> b6 <span class="number">0</span>c <span class="number">03</span>             movzbl (%rbx,%rax,<span class="number">1</span>),%ecx</span><br><span class="line">  <span class="number">40108f</span>:       <span class="number">88</span> <span class="number">0</span>c <span class="number">24</span>                mov    %cl,(%rsp)</span><br><span class="line">  <span class="number">401092</span>:       <span class="number">48</span> <span class="number">8b</span> <span class="number">14</span> <span class="number">24</span>             mov    (%rsp),%rdx</span><br><span class="line">  <span class="number">401096</span>:       <span class="number">83</span> e2 <span class="number">0f</span>                <span class="keyword">and</span>    $<span class="number">0xf</span>,%edx</span><br><span class="line">  <span class="number">401099</span>:       <span class="number">0f</span> b6 <span class="number">92</span> b0 <span class="number">24</span> <span class="number">40</span> <span class="number">00</span>    movzbl <span class="number">0x4024b0</span>(%rdx),%edx</span><br><span class="line">  <span class="number">4010</span>a0:       <span class="number">88</span> <span class="number">54</span> <span class="number">04</span> <span class="number">10</span>             mov    %dl,<span class="number">0x10</span>(%rsp,%rax,<span class="number">1</span>)</span><br><span class="line">  实际上是a[i] = <span class="number">0x4024b0</span>[input[i] &amp; <span class="number">0xf</span>]</span><br><span class="line">  <span class="number">4010</span>a4:       <span class="number">48</span> <span class="number">83</span> c0 <span class="number">01</span>             add    $<span class="number">0x1</span>,%rax</span><br><span class="line">  <span class="number">4010</span>a8:       <span class="number">48</span> <span class="number">83</span> f8 <span class="number">06</span>             cmp    $<span class="number">0x6</span>,%rax</span><br><span class="line">  <span class="number">4010</span>ac:       <span class="number">75</span> dd                   jne    <span class="number">40108b</span> &lt;phase_5+<span class="number">0x29</span>&gt;</span><br><span class="line">  # 循环以及条件判断</span><br><span class="line">  <span class="number">4010</span>ae:       c6 <span class="number">44</span> <span class="number">24</span> <span class="number">16</span> <span class="number">00</span>          movb   $<span class="number">0x0</span>,<span class="number">0x16</span>(%rsp)</span><br><span class="line">  # 为构造的字符串尾部加上<span class="string">'\0'</span></span><br><span class="line">  <span class="number">4010b</span>3:       be <span class="number">5</span>e <span class="number">24</span> <span class="number">40</span> <span class="number">00</span>          mov    $<span class="number">0x40245e</span>,%esi</span><br><span class="line">  <span class="number">4010b</span>8:       <span class="number">48</span> <span class="number">8</span>d <span class="number">7</span>c <span class="number">24</span> <span class="number">10</span>          lea    <span class="number">0x10</span>(%rsp),%rdi</span><br><span class="line">  <span class="number">4010b</span>d:       e8 <span class="number">76</span> <span class="number">02</span> <span class="number">00</span> <span class="number">00</span>          callq  <span class="number">401338</span> &lt;strings_not_equal&gt;</span><br><span class="line">  # 调用strings_not_equal函数</span><br><span class="line">  <span class="number">4010</span>c2:       <span class="number">85</span> c0                   test   %eax,%eax</span><br><span class="line">  <span class="number">4010</span>c4:       <span class="number">74</span> <span class="number">13</span>                   je     <span class="number">4010</span>d9 &lt;phase_5+<span class="number">0x77</span>&gt;</span><br><span class="line">  # 若返回值不为<span class="number">0</span> 则引爆bomb</span><br><span class="line">  <span class="number">4010</span>c6:       e8 <span class="number">6f</span> <span class="number">03</span> <span class="number">00</span> <span class="number">00</span>          callq  <span class="number">40143</span>a &lt;explode_bomb&gt;</span><br><span class="line">  <span class="number">4010</span>cb:       <span class="number">0f</span> <span class="number">1f</span> <span class="number">44</span> <span class="number">00</span> <span class="number">00</span>          nopl   <span class="number">0x0</span>(%rax,%rax,<span class="number">1</span>)</span><br><span class="line">  <span class="number">4010</span>d0:       eb <span class="number">07</span>                   jmp    <span class="number">4010</span>d9 &lt;phase_5+<span class="number">0x77</span>&gt;</span><br><span class="line">  <span class="number">4010</span>d2:       b8 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>          mov    $<span class="number">0x0</span>,%eax</span><br><span class="line">  <span class="number">4010</span>d7:       eb b2                   jmp    <span class="number">40108b</span> &lt;phase_5+<span class="number">0x29</span>&gt;</span><br><span class="line">  <span class="number">4010</span>d9:       <span class="number">48</span> <span class="number">8b</span> <span class="number">44</span> <span class="number">24</span> <span class="number">18</span>          mov    <span class="number">0x18</span>(%rsp),%rax</span><br><span class="line">  <span class="number">4010</span>de:       <span class="number">64</span> <span class="number">48</span> <span class="number">33</span> <span class="number">04</span> <span class="number">25</span> <span class="number">28</span> <span class="number">00</span>    <span class="keyword">xor</span>    %fs:<span class="number">0x28</span>,%rax</span><br><span class="line">  <span class="number">4010e5</span>:       <span class="number">00</span> <span class="number">00</span></span><br><span class="line">  <span class="number">4010e7</span>:       <span class="number">74</span> <span class="number">05</span>                   je     <span class="number">4010</span>ee &lt;phase_5+<span class="number">0x8c</span>&gt;</span><br><span class="line">  <span class="number">4010e9</span>:       e8 <span class="number">42</span> fa ff ff          callq  <span class="number">400b</span>30 &lt;__stack_chk_fai</span><br><span class="line">l@plt&gt;</span><br><span class="line">  <span class="number">4010</span>ee:       <span class="number">48</span> <span class="number">83</span> c4 <span class="number">20</span>             add    $<span class="number">0x20</span>,%rsp</span><br><span class="line">  <span class="number">4010f</span>2:       <span class="number">5b</span>                      pop    %rbx</span><br><span class="line">  <span class="number">4010f</span>3:       c3                      retq   </span><br><span class="line"> </span><br></pre></td></tr></table></figure>

<p>首先，我们注意到phase_5采用了栈破坏检测机制，并且设置了相应的哨兵值防止栈缓冲区溢出。<br>然后我们将phase_5逆向，得到如下的结果：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">phase_5</span><span class="params">(<span class="keyword">char</span> * input)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">char</span> a[<span class="number">7</span>];</span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">strlen</span>(input) != <span class="number">6</span>) explode_bomb();</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; <span class="number">6</span> ; i++)</span><br><span class="line">		a[i] = <span class="number">0x4024b0</span>[input[i] &amp; <span class="number">0xf</span>];</span><br><span class="line">	a[<span class="number">6</span>] = <span class="string">'\0'</span>;</span><br><span class="line">	<span class="keyword">int</span> val = strings_not_equal(a, <span class="number">0x40245e</span>);</span><br><span class="line">	<span class="keyword">if</span> (val != <span class="number">0</span>) explode_bomb();</span><br><span class="line">	<span class="keyword">return</span>;</span><br><span class="line"> </span><br></pre></td></tr></table></figure>

<p>在GDB中打印0x4024b0和0x40245e所对应的字符串，命令和结果如下所示：</p>
<p><img src="/2020/05/05/bomblab/18.PNG" alt="18"></p>
<p>在有了目标字符串后，我们现在知道了上述的字符串可以看做是一张查找表，可以得到对应关系：</p>
<p>0123456789abcdef<br>maduiersnfotvbyl</p>
<p>所以，我们要得到 “flyers”，就应该输入“9 f e 5 6 7”，将数字对应到 ASCII 码中的字符，可以得到“INOEFG”。</p>
<p><img src="/2020/05/05/bomblab/5.PNG" alt="5"></p>
</li>
<li><p>phase_6:</p>
<p>关卡 6 需要仔细分析，我使用了 GDB 单步运行的方法来分析了运行过程。首先，函数要求读入 6 个数，并确认个数是否为 6。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00000000004010f</span>4 &lt;phase_6&gt;:</span><br><span class="line">  <span class="number">4010f</span>4:	<span class="number">41</span> <span class="number">56</span>                	push   %r14</span><br><span class="line">  <span class="number">4010f</span>6:	<span class="number">41</span> <span class="number">55</span>                	push   %r13</span><br><span class="line">  <span class="number">4010f</span>8:	<span class="number">41</span> <span class="number">54</span>                	push   %r12</span><br><span class="line">  <span class="number">4010f</span>a:	<span class="number">55</span>                   	push   %rbp</span><br><span class="line">  <span class="number">4010f</span>b:	<span class="number">53</span>                   	push   %rbx</span><br><span class="line">  <span class="number">4010f</span>c:	<span class="number">48</span> <span class="number">83</span> ec <span class="number">50</span>          	sub    $<span class="number">0x50</span>,%rsp</span><br><span class="line">  <span class="number">401100</span>:	<span class="number">49</span> <span class="number">89</span> e5             	mov    %rsp,%r13</span><br><span class="line">  <span class="number">401103</span>:	<span class="number">48</span> <span class="number">89</span> e6             	mov    %rsp,%rsi</span><br><span class="line">  <span class="number">401106</span>:	e8 <span class="number">51</span> <span class="number">03</span> <span class="number">00</span> <span class="number">00</span>       	callq  <span class="number">40145</span>c &lt;read_six_numbers&gt;</span><br><span class="line">  <span class="number">40110b</span>:	<span class="number">49</span> <span class="number">89</span> e6             	mov    %rsp,%r14</span><br><span class="line">  <span class="number">40110</span>e:	<span class="number">41</span> bc <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>    	mov    $<span class="number">0x0</span>,%r12d</span><br><span class="line">  <span class="number">401114</span>:	<span class="number">4</span>c <span class="number">89</span> ed             	mov    %r13,%rbp</span><br><span class="line">  <span class="number">401117</span>:	<span class="number">41</span> <span class="number">8b</span> <span class="number">45</span> <span class="number">00</span>          	mov    <span class="number">0x0</span>(%r13),%eax</span><br><span class="line">  <span class="number">40111b</span>:	<span class="number">83</span> e8 <span class="number">01</span>             	sub    $<span class="number">0x1</span>,%eax</span><br><span class="line">  <span class="number">40111</span>e:	<span class="number">83</span> f8 <span class="number">05</span>             	cmp    $<span class="number">0x5</span>,%eax</span><br><span class="line">  <span class="number">401121</span>:	<span class="number">76</span> <span class="number">05</span>                	jbe    <span class="number">401128</span> &lt;phase_6+<span class="number">0x34</span>&gt;</span><br><span class="line">  <span class="number">401123</span>:	e8 <span class="number">12</span> <span class="number">03</span> <span class="number">00</span> <span class="number">00</span>       	callq  <span class="number">40143</span>a &lt;explode_bomb&gt;</span><br></pre></td></tr></table></figure>

<p>然后，通过双重循环，判断 6 个数之间不存在重复。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">401138</span>:	<span class="number">8b</span> <span class="number">04</span> <span class="number">84</span>             	mov    (%rsp,%rax,<span class="number">4</span>),%eax</span><br><span class="line"><span class="number">40113b</span>:	<span class="number">39</span> <span class="number">45</span> <span class="number">00</span>             	cmp    %eax,<span class="number">0x0</span>(%rbp)</span><br><span class="line"><span class="number">40113</span>e:	<span class="number">75</span> <span class="number">05</span>                	jne    <span class="number">401145</span> &lt;phase_6+<span class="number">0x51</span>&gt;</span><br><span class="line"><span class="number">401140</span>:	e8 f5 <span class="number">02</span> <span class="number">00</span> <span class="number">00</span>       	callq  <span class="number">40143</span>a &lt;explode_bomb&gt;</span><br><span class="line"><span class="number">401145</span>:	<span class="number">83</span> c3 <span class="number">01</span>             	add    $<span class="number">0x1</span>,%ebx</span><br><span class="line"><span class="number">401148</span>:	<span class="number">83</span> fb <span class="number">05</span>             	cmp    $<span class="number">0x5</span>,%ebx</span><br><span class="line"><span class="number">40114b</span>:	<span class="number">7</span>e e8                	jle    <span class="number">401135</span> &lt;phase_6+<span class="number">0x41</span>&gt;</span><br><span class="line"><span class="number">40114</span>d:	<span class="number">49</span> <span class="number">83</span> c5 <span class="number">04</span>          	add    $<span class="number">0x4</span>,%r13</span><br><span class="line"><span class="number">401151</span>:	eb c1                	jmp    <span class="number">401114</span> &lt;phase_6+<span class="number">0x20</span>&gt;</span><br><span class="line"><span class="number">401153</span>:	<span class="number">48</span> <span class="number">8</span>d <span class="number">74</span> <span class="number">24</span> <span class="number">18</span>       	lea    <span class="number">0x18</span>(%rsp),%rsi</span><br><span class="line"><span class="number">401158</span>:	<span class="number">4</span>c <span class="number">89</span> f0             	mov    %r14,%rax</span><br><span class="line"><span class="number">40115b</span>:	b9 <span class="number">07</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       	mov    $<span class="number">0x7</span>,%ecx</span><br><span class="line"><span class="number">401160</span>:	<span class="number">89</span> ca                	mov    %ecx,%edx</span><br><span class="line"><span class="number">401162</span>:	<span class="number">2b</span> <span class="number">10</span>                	sub    (%rax),%edx</span><br><span class="line"><span class="number">401164</span>:	<span class="number">89</span> <span class="number">10</span>                	mov    %edx,(%rax)</span><br><span class="line"><span class="number">401166</span>:	<span class="number">48</span> <span class="number">83</span> c0 <span class="number">04</span>          	add    $<span class="number">0x4</span>,%rax</span><br><span class="line"><span class="number">40116</span>a:	<span class="number">48</span> <span class="number">39</span> f0             	cmp    %rsi,%rax</span><br><span class="line"><span class="number">40116</span>d:	<span class="number">75</span> f1                	jne    <span class="number">401160</span> &lt;phase_6+<span class="number">0x6c</span>&gt;</span><br><span class="line"><span class="number">40116f</span>:	be <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       	mov    $<span class="number">0x0</span>,%esi</span><br><span class="line"><span class="number">401174</span>:	eb <span class="number">21</span>                	jmp    <span class="number">401197</span> &lt;phase_6+<span class="number">0xa3</span>&gt;</span><br><span class="line"><span class="number">401176</span>:	<span class="number">48</span> <span class="number">8b</span> <span class="number">52</span> <span class="number">08</span>          	mov    <span class="number">0x8</span>(%rdx),%rdx</span><br><span class="line"><span class="number">40117</span>a:	<span class="number">83</span> c0 <span class="number">01</span>             	add    $<span class="number">0x1</span>,%eax</span><br><span class="line"><span class="number">40117</span>d:	<span class="number">39</span> c8                	cmp    %ecx,%eax</span><br><span class="line"><span class="number">40117f</span>:	<span class="number">75</span> f5                	jne    <span class="number">401176</span> &lt;phase_6+<span class="number">0x82</span>&gt;</span><br></pre></td></tr></table></figure>

<p>这里有一个要细节，就是这段代码保存了和 7 的差：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">401158</span>:	<span class="number">4</span>c <span class="number">89</span> f0             	mov    %r14,%rax</span><br><span class="line"><span class="number">40115b</span>:	b9 <span class="number">07</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       	mov    $<span class="number">0x7</span>,%ecx</span><br><span class="line"><span class="number">401160</span>:	<span class="number">89</span> ca                	mov    %ecx,%edx</span><br><span class="line"> </span><br></pre></td></tr></table></figure>

<p>接下来的代码中，有一个奇怪的地址，我们打印它的内容：</p>
<p><img src="/2020/05/05/bomblab/19.png" alt="19"></p>
<p>通过分析这个结构，我们可以看到它是一个链表，定义类似于:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Node</span> &#123;</span></span><br><span class="line">	<span class="keyword">int</span> value;</span><br><span class="line">	<span class="keyword">int</span> index;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">node</span> *<span class="title">next</span>;</span></span><br><span class="line">&#125;</span><br><span class="line"> </span><br></pre></td></tr></table></figure>

<p>接下来，代码要求由大到小获取链表中的值：</p>
<p>所以我们打印链表的节点值：</p>
<p><img src="/2020/05/05/bomblab/20.png" alt="20"></p>
<p>从大到小排列他们的索引分别是：3 4 5 6 1 2，考虑被 7 减的操作，所以答案是：4 3 2 1 6 5</p>
<p>![6]/bomblab/6.PNG)</p>
</li>
<li><p>隐藏关卡</p>
<p>隐藏关卡的入口在 <code>phase_defused</code> 中，所以，我们在函数入口设置断点，研究怎样才能进入<code>secret_phase</code>。<code>phase_defused</code> 的开头统计了我们目前输入了多少个答案，如果不为 6，那么你永远都无法触发隐藏关卡。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00000000004015</span>c4 &lt;phase_defused&gt;:</span><br><span class="line">  <span class="number">4015</span>c4:	<span class="number">48</span> <span class="number">83</span> ec <span class="number">78</span>          	sub    $<span class="number">0x78</span>,%rsp</span><br><span class="line">  <span class="number">4015</span>c8:	<span class="number">64</span> <span class="number">48</span> <span class="number">8b</span> <span class="number">04</span> <span class="number">25</span> <span class="number">28</span> <span class="number">00</span> 	mov    %fs:<span class="number">0x28</span>,%rax</span><br><span class="line">  <span class="number">4015</span>cf:	<span class="number">00</span> <span class="number">00</span> </span><br><span class="line">  <span class="number">4015</span>d1:	<span class="number">48</span> <span class="number">89</span> <span class="number">44</span> <span class="number">24</span> <span class="number">68</span>       	mov    %rax,<span class="number">0x68</span>(%rsp)</span><br><span class="line">  <span class="number">4015</span>d6:	<span class="number">31</span> c0                	<span class="keyword">xor</span>    %eax,%eax</span><br><span class="line">  <span class="number">4015</span>d8:	<span class="number">83</span> <span class="number">3</span>d <span class="number">81</span> <span class="number">21</span> <span class="number">20</span> <span class="number">00</span> <span class="number">06</span> 	cmpl   $<span class="number">0x6</span>,<span class="number">0x202181</span>(%rip)        # <span class="number">603760</span> &lt;num_input_strings&gt;</span><br><span class="line">  <span class="number">4015</span>df:	<span class="number">75</span> <span class="number">5</span>e                	jne    <span class="number">40163f</span> &lt;phase_defused+<span class="number">0x7b</span>&gt;</span><br><span class="line"> </span><br></pre></td></tr></table></figure>

<p>接下来，我们分析触发 <code>secret_phase</code> 的代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">4015e1</span>:	<span class="number">4</span>c <span class="number">8</span>d <span class="number">44</span> <span class="number">24</span> <span class="number">10</span>       	lea    <span class="number">0x10</span>(%rsp),%r8</span><br><span class="line"><span class="number">4015e6</span>:	<span class="number">48</span> <span class="number">8</span>d <span class="number">4</span>c <span class="number">24</span> <span class="number">0</span>c       	lea    <span class="number">0xc</span>(%rsp),%rcx</span><br><span class="line"><span class="number">4015</span>eb:	<span class="number">48</span> <span class="number">8</span>d <span class="number">54</span> <span class="number">24</span> <span class="number">08</span>       	lea    <span class="number">0x8</span>(%rsp),%rdx</span><br><span class="line"><span class="number">4015f</span>0:	be <span class="number">19</span> <span class="number">26</span> <span class="number">40</span> <span class="number">00</span>       	mov    $<span class="number">0x402619</span>,%esi</span><br><span class="line"><span class="number">4015f</span>5:	bf <span class="number">70</span> <span class="number">38</span> <span class="number">60</span> <span class="number">00</span>       	mov    $<span class="number">0x603870</span>,%edi</span><br><span class="line"><span class="number">4015f</span>a:	e8 f1 f5 ff ff       	callq  <span class="number">400b</span>f0 &lt;__isoc99_sscanf@plt&gt;</span><br><span class="line"><span class="number">4015f</span>f:	<span class="number">83</span> f8 <span class="number">03</span>             	cmp    $<span class="number">0x3</span>,%eax</span><br><span class="line"><span class="number">401602</span>:	<span class="number">75</span> <span class="number">31</span>                	jne    <span class="number">401635</span> &lt;phase_defused+<span class="number">0x71</span>&gt;</span><br><span class="line"><span class="number">401604</span>:	be <span class="number">22</span> <span class="number">26</span> <span class="number">40</span> <span class="number">00</span>       	mov    $<span class="number">0x402622</span>,%esi</span><br><span class="line"><span class="number">401609</span>:	<span class="number">48</span> <span class="number">8</span>d <span class="number">7</span>c <span class="number">24</span> <span class="number">10</span>       	lea    <span class="number">0x10</span>(%rsp),%rdi</span><br><span class="line"><span class="number">40160</span>e:	e8 <span class="number">25</span> fd ff ff       	callq  <span class="number">401338</span> &lt;strings_not_equal&gt;</span><br><span class="line"><span class="number">401613</span>:	<span class="number">85</span> c0                	test   %eax,%eax</span><br><span class="line"><span class="number">401615</span>:	<span class="number">75</span> <span class="number">1</span>e                	jne    <span class="number">401635</span> &lt;phase_defused+<span class="number">0x71</span>&gt;</span><br><span class="line"><span class="number">401617</span>:	bf f8 <span class="number">24</span> <span class="number">40</span> <span class="number">00</span>       	mov    $<span class="number">0x4024f8</span>,%edi</span><br><span class="line"><span class="number">40161</span>c:	e8 ef f4 ff ff       	callq  <span class="number">400b</span>10 &lt;<span class="built_in">puts</span>@plt&gt;</span><br><span class="line"><span class="number">401621</span>:	bf <span class="number">20</span> <span class="number">25</span> <span class="number">40</span> <span class="number">00</span>       	mov    $<span class="number">0x402520</span>,%edi</span><br><span class="line"><span class="number">401626</span>:	e8 e5 f4 ff ff       	callq  <span class="number">400b</span>10 &lt;<span class="built_in">puts</span>@plt&gt;</span><br><span class="line"><span class="number">40162b</span>:	b8 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       	mov    $<span class="number">0x0</span>,%eax</span><br><span class="line"><span class="number">401630</span>:	e8 <span class="number">0</span>d fc ff ff       	callq  <span class="number">401242</span> &lt;secret_phase&gt;</span><br></pre></td></tr></table></figure>

<p>首先程序将三个值保存在寄存器，我们查看它们的内容：</p>
<p><img src="/2020/05/05/bomblab/21.png" alt="21"></p>
<p>分别是7、4、3。</p>
<p>下面是两个特殊的地址，并且将地址指向的值作为了 <code>sscanf</code> 的参数。我们打印这两个特殊地址的值：</p>
<p><img src="/2020/05/05/bomblab/22.png" alt="22"></p>
<p>现在我们可以看到，<code>sscanf</code> 要求的输入格式是两个整数和一个字符串，而其中的两个整数是我们在关卡 4输入的值，那么剩下的字符串应该是什么呢？</p>
<p>我们可以看到，剩余的代码中还有一系列地址，我们打印他们指向的内存中的值：</p>
<p><img src="/2020/05/05/bomblab/23.png" alt="23"></p>
<p>可以看到最后一个就是我们想要的字符串。我们把它加到关卡 4 的答案后面即可进入隐藏关卡。</p>
<p>接下来我们查看隐藏关卡的代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0000000000401242</span> &lt;secret_phase&gt;:</span><br><span class="line">  <span class="number">401242</span>:	<span class="number">53</span>                   	push   %rbx</span><br><span class="line">  <span class="number">401243</span>:	e8 <span class="number">56</span> <span class="number">02</span> <span class="number">00</span> <span class="number">00</span>       	callq  <span class="number">40149</span>e &lt;read_line&gt;</span><br><span class="line">  <span class="number">401248</span>:	ba <span class="number">0</span>a <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       	mov    $<span class="number">0xa</span>,%edx</span><br><span class="line">  <span class="number">40124</span>d:	be <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       	mov    $<span class="number">0x0</span>,%esi</span><br><span class="line">  <span class="number">401252</span>:	<span class="number">48</span> <span class="number">89</span> c7             	mov    %rax,%rdi</span><br><span class="line">  <span class="number">401255</span>:	e8 <span class="number">76</span> f9 ff ff       	callq  <span class="number">400b</span>d0 &lt;strtol@plt&gt;</span><br><span class="line">  <span class="number">40125</span>a:	<span class="number">48</span> <span class="number">89</span> c3             	mov    %rax,%rbx</span><br><span class="line">  <span class="number">40125</span>d:	<span class="number">8</span>d <span class="number">40</span> ff             	lea    <span class="number">-0x1</span>(%rax),%eax</span><br><span class="line">  <span class="number">401260</span>:	<span class="number">3</span>d e8 <span class="number">03</span> <span class="number">00</span> <span class="number">00</span>       	cmp    $<span class="number">0x3e8</span>,%eax</span><br><span class="line">  <span class="number">401265</span>:	<span class="number">76</span> <span class="number">05</span>                	jbe    <span class="number">40126</span>c &lt;secret_phase+<span class="number">0x2a</span>&gt;</span><br><span class="line">  <span class="number">401267</span>:	e8 ce <span class="number">01</span> <span class="number">00</span> <span class="number">00</span>       	callq  <span class="number">40143</span>a &lt;explode_bomb&gt;</span><br><span class="line">  <span class="number">40126</span>c:	<span class="number">89</span> de                	mov    %ebx,%esi</span><br><span class="line">  <span class="number">40126</span>e:	bf f0 <span class="number">30</span> <span class="number">60</span> <span class="number">00</span>       	mov    $<span class="number">0x6030f0</span>,%edi</span><br><span class="line">  <span class="number">401273</span>:	e8 <span class="number">8</span>c ff ff ff       	callq  <span class="number">401204</span> &lt;fun7&gt;</span><br><span class="line">  <span class="number">401278</span>:	<span class="number">83</span> f8 <span class="number">02</span>             	cmp    $<span class="number">0x2</span>,%eax</span><br><span class="line">  <span class="number">40127b</span>:	<span class="number">74</span> <span class="number">05</span>                	je     <span class="number">401282</span> &lt;secret_phase+<span class="number">0x40</span>&gt;</span><br><span class="line">  <span class="number">40127</span>d:	e8 b8 <span class="number">01</span> <span class="number">00</span> <span class="number">00</span>       	callq  <span class="number">40143</span>a &lt;explode_bomb&gt;</span><br><span class="line">  <span class="number">401282</span>:	bf <span class="number">38</span> <span class="number">24</span> <span class="number">40</span> <span class="number">00</span>       	mov    $<span class="number">0x402438</span>,%edi</span><br><span class="line">  <span class="number">401287</span>:	e8 <span class="number">84</span> f8 ff ff       	callq  <span class="number">400b</span>10 &lt;<span class="built_in">puts</span>@plt&gt;</span><br><span class="line">  <span class="number">40128</span>c:	e8 <span class="number">33</span> <span class="number">03</span> <span class="number">00</span> <span class="number">00</span>       	callq  <span class="number">4015</span>c4 &lt;phase_defused&gt;</span><br><span class="line">  <span class="number">401291</span>:	<span class="number">5b</span>                   	pop    %rbx</span><br><span class="line">  <span class="number">401292</span>:	c3                   	retq</span><br><span class="line"> </span><br></pre></td></tr></table></figure>

<p>代码首先读入一个字符串，然后调用 <code>strtol</code> 将它转换成 10 进制数，并和 0x3e8（也就是 1000）比较，如果大于1000，则引爆；否则，调用 <code>fun7</code>，<code>fun7</code>的参数是一个地址和一个数。如果 <code>fun7</code> 的返回值等于 2，则拆弹成功。</p>
<p>下面是fun7的汇编代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0000000000401204</span> &lt;fun7&gt;:</span><br><span class="line">  <span class="number">401204</span>:	<span class="number">48</span> <span class="number">83</span> ec <span class="number">08</span>          	sub    $<span class="number">0x8</span>,%rsp</span><br><span class="line">  <span class="number">401208</span>:	<span class="number">48</span> <span class="number">85</span> ff             	test   %rdi,%rdi</span><br><span class="line">  <span class="number">40120b</span>:	<span class="number">74</span> <span class="number">2b</span>                	je     <span class="number">401238</span> &lt;fun7+<span class="number">0x34</span>&gt;</span><br><span class="line">  <span class="number">40120</span>d:	<span class="number">8b</span> <span class="number">17</span>                	mov    (%rdi),%edx</span><br><span class="line">  <span class="number">40120f</span>:	<span class="number">39</span> f2                	cmp    %esi,%edx</span><br><span class="line">  <span class="number">401211</span>:	<span class="number">7</span>e <span class="number">0</span>d                	jle    <span class="number">401220</span> &lt;fun7+<span class="number">0x1c</span>&gt;</span><br><span class="line">  <span class="number">401213</span>:	<span class="number">48</span> <span class="number">8b</span> <span class="number">7f</span> <span class="number">08</span>          	mov    <span class="number">0x8</span>(%rdi),%rdi</span><br><span class="line">  <span class="number">401217</span>:	e8 e8 ff ff ff       	callq  <span class="number">401204</span> &lt;fun7&gt;</span><br><span class="line">  <span class="number">40121</span>c:	<span class="number">01</span> c0                	add    %eax,%eax</span><br><span class="line">  <span class="number">40121</span>e:	eb <span class="number">1</span>d                	jmp    <span class="number">40123</span>d &lt;fun7+<span class="number">0x39</span>&gt;</span><br><span class="line">  <span class="number">401220</span>:	b8 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       	mov    $<span class="number">0x0</span>,%eax</span><br><span class="line">  <span class="number">401225</span>:	<span class="number">39</span> f2                	cmp    %esi,%edx</span><br><span class="line">  <span class="number">401227</span>:	<span class="number">74</span> <span class="number">14</span>                	je     <span class="number">40123</span>d &lt;fun7+<span class="number">0x39</span>&gt;</span><br><span class="line">  <span class="number">401229</span>:	<span class="number">48</span> <span class="number">8b</span> <span class="number">7f</span> <span class="number">10</span>          	mov    <span class="number">0x10</span>(%rdi),%rdi</span><br><span class="line">  <span class="number">40122</span>d:	e8 d2 ff ff ff       	callq  <span class="number">401204</span> &lt;fun7&gt;</span><br><span class="line">  <span class="number">401232</span>:	<span class="number">8</span>d <span class="number">44</span> <span class="number">00</span> <span class="number">01</span>          	lea    <span class="number">0x1</span>(%rax,%rax,<span class="number">1</span>),%eax</span><br><span class="line">  <span class="number">401236</span>:	eb <span class="number">05</span>                	jmp    <span class="number">40123</span>d &lt;fun7+<span class="number">0x39</span>&gt;</span><br><span class="line">  <span class="number">401238</span>:	b8 ff ff ff ff       	mov    $<span class="number">0xffffffff</span>,%eax</span><br><span class="line">  <span class="number">40123</span>d:	<span class="number">48</span> <span class="number">83</span> c4 <span class="number">08</span>          	add    $<span class="number">0x8</span>,%rsp</span><br><span class="line">  <span class="number">401241</span>:	c3                   	retq</span><br><span class="line"> </span><br></pre></td></tr></table></figure>

<p><code>fun7</code> 是一个递归函数，它的 C 语言版本为：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// %rdi 为 &amp;x, %esi 为 y</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">fun7</span><span class="params">(<span class="keyword">int</span> *x, <span class="keyword">int</span> y)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (x == <span class="literal">NULL</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">int</span> ret = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (*x &lt; y) &#123;</span><br><span class="line">        ret = fun7(x + <span class="number">0x10</span>, y);</span><br><span class="line">        ret = ret * <span class="number">2</span> + <span class="number">1</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (*x == y) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        ret = fun7(x + <span class="number">0x8</span>, y);</span><br><span class="line">        ret *= <span class="number">2</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>为了让 <code>fun7</code> 返回 2，需要递归三层：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2</span> = <span class="number">2</span> <span class="number">1</span></span><br><span class="line"><span class="number">1</span> = <span class="number">2</span> <span class="number">0</span> + <span class="number">1</span></span><br><span class="line"><span class="number">0</span> = <span class="number">0</span></span><br><span class="line"> </span><br></pre></td></tr></table></figure>

<p>我们让 0x6030f0 + 0x08 + 0x10 = 0x603108，访问这个地址，我们得到 0x16（十进制为 22）。</p>
<p><img src="/2020/05/05/bomblab/7.PNG" alt="7"></p>
</li>
</ul>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/csapp/" rel="tag"># csapp</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2020/05/05/OS%E5%AE%9E%E9%AA%8C/" rel="prev" title="OS实验">
      <i class="fa fa-chevron-left"></i> OS实验
    </a></div>
      <div class="post-nav-item">
    <a href="/2020/05/05/cachelab/" rel="next" title="cachelab">
      cachelab <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Inhaltsverzeichnis
        </li>
        <li class="sidebar-nav-overview">
          Übersicht
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#BOMBLAB"><span class="nav-number">1.</span> <span class="nav-text">BOMBLAB</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#一、实验内容及要求"><span class="nav-number">1.1.</span> <span class="nav-text">一、实验内容及要求</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#二、实验过程分析及截图"><span class="nav-number">1.2.</span> <span class="nav-text">二、实验过程分析及截图</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-实验准备"><span class="nav-number">1.2.1.</span> <span class="nav-text">1.实验准备</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-实验过程"><span class="nav-number">1.2.2.</span> <span class="nav-text">2.实验过程</span></a></li></ol></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">般若</p>
  <div class="site-description" itemprop="description">般若的blog</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">15</span>
          <span class="site-state-item-name">Artikel</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
        <span class="site-state-item-count">8</span>
        <span class="site-state-item-name">Kategorien</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
        <span class="site-state-item-count">12</span>
        <span class="site-state-item-name">schlagwörter</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2020 – 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">BoRe</span>
</div>
  <div class="powered-by">Erstellt mit  <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/medium-zoom@1/dist/medium-zoom.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

  

</body>
</html>
